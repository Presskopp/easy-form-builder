
/* 
 Created by : Hassan Tafreshi
 Copy right owner : whiteStudio.team
 Desc: This multi-select is designed base on boostrap 5 and used for Easy form builder Wordpress Plugin
 */


 let lastEventClickIdEfb="";
 let nothingSelectMessageEfb = `Nothing selected`;
 let listMSelectEfb =[];

function create_multiselect(id,options){
    console.log(options);
    //const options =['Hassan','Ehssan','Mine'];
    let obj =`<!--List-->`
    for(ob in options){
        obj += `<div data-id="${id}" class="form-check efbSelect" ><input class="efb efbSelect" type="checkbox" data-id="${id}" value="" id="${id}-${ob}">
             <label class="efb multiSelect efbSelect" data-id="${id}"  for="${id}-${ob}" id="${id}-${ob}-value">${options[ob]}</label></div>`
    }
    const el=document.getElementById(id);
    const newNode= document.createElement("div");
    newNode.className="efb d-none efbSelect mselect-list border border-2";
    newNode.id=id+'-list';
    newNode.innerHTML=obj;
    el.className += 'efb col-12 efbSelect mselect border border-1 row';
    el.dataset.id = id;
    el.dataset.value = "";
    if(el.innerHTML.length<2)el.innerHTML=nothingSelectMessageEfb;
    el.parentNode.insertBefore(newNode, el.nextSibling);
  
    el.addEventListener('click',()=>{
        const listId= el.id +'-list';
        document.getElementById(listId).classList.contains('d-none') ?  document.getElementById(listId).classList.remove('d-none') : document.getElementById(listId).classList.add('d-none')
    })

    document.addEventListener("click", (evnt) => {
        console.log(evnt.target);
        if(lastEventClickIdEfb.length>1 && !evnt.target.classList.contains('efbSelect')){
            document.getElementById(lastEventClickIdEfb).classList.add('d-none');
        }else if(evnt.target.classList.contains('efbSelect')){
            lastEventClickIdEfb=evnt.target.dataset.id+"-list";
            console.log(evnt.target.tagName,lastEventClickIdEfb);
            if(evnt.target.type=="checkbox"){
                if(evnt.target.checked==true){
                        const id = evnt.target.id + '-value';
                        const value = document.getElementById(id).innerHTML;
                       
                        if(document.getElementById(evnt.target.dataset.id).dataset.value.length<1){
                            document.getElementById(evnt.target.dataset.id).innerHTML=`<span class="efb btn-darkb text-white  py-1 px-2 mselect  efbSelect selected" data-id="${evnt.target.dataset.id}" data-ob="${evnt.target.id}">${value}</span>`
                            document.getElementById(evnt.target.dataset.id).dataset.value =  value ;
                            listMSelectEfb.push({id:evnt.target.dataset.id,select:[{id:evnt.target.id,value:value}]})
                            console.log(listMSelectEfb);
                        }else{
                            document.getElementById(evnt.target.dataset.id).dataset.value +=   " , "+value ;
                            document.getElementById(evnt.target.dataset.id).innerHTML+=`<span class="efb btn-darkb text-white py-1 px-2 mselect  efbSelect selected" data-id="${evnt.target.dataset.id}" data-ob="${evnt.target.id}">${value}</span>`
                            const obj =listMSelectEfb.find(x=>x.id==evnt.target.dataset.id)
                            obj.select.push({id:evnt.target.id,value:value})
                            console.log(obj.select);
                        }
                }else{
                    removeSelectedOptionEfb(evnt.target)
                }
            }else if(evnt.target.tagName=="SPAN"){
                removeSelectedOptionEfb(evnt.target)
            }
            document.getElementById(lastEventClickIdEfb).classList.remove('d-none');
        }
        
    });
}


const removeSelectedOptionEfb=(el)=>{
    console.log(el);
    let e = document.getElementById(el.dataset.id);
    if(el.tagName=="SPAN"){
        const id = el.dataset.id;
        const ob = el.dataset.ob;
        let v =  e.dataset.value
        document.getElementById(ob).checked=false;
        console.log(id,ob)
        el.remove();       
        removeObMselectEfb(id ,ob)
    }else{
        const ob =el.id
        const ed = document.querySelector(`[data-ob="${ob}"]`)
        const id = ed.dataset.id;
        ed.remove();
        removeObMselectEfb(id ,ob)
    }
    
    if(e.innerHTML.length<2) e.innerHTML= nothingSelectMessageEfb;
}

const removeObMselectEfb=(id , ob)=>{
    let value ='';
    let obj = listMSelectEfb.find(x=>x.id ==id);
    const n = obj.select.findIndex(x=>x.id == ob);
    console.log(n , obj.select[n]);
    obj.select.splice(n,1);
   for(const o of obj.select){
       value += o.value + ', '
   }
   document.getElementById(id).dataset.value = value;
}

const removeAllMselectEfb=(id)=>{
    let obj = listMSelectEfb.findIndex(x=>x.id ==id);
    listMSelectEfb.splice(obj,1);
    document.getElementById(id).dataset.value ='';
}

const selectAllMselectEfb=(id)=>{

}